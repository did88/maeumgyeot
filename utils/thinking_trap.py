# utils/thinking_trap.py

import re

thinking_traps = {
    "흑백 사고": ["항상", "절대", "완전히", "모두", "하나도"],
    "과잉 일반화": ["늘", "언제나", "전부", "다들", "나는 항상"],
    "정신적 여과": ["하나도 안 돼", "또 실수했어", "안 좋은 일만"],
    "긍정 무시": ["그건 우연이야", "별거 아냐", "내가 잘한 게 아냐"],
    "마음 읽기": ["걔는 날 싫어할 거야", "쟤는 분명 날 무시해", "분명히 싫어할 거야"],
    "예언하기": ["또 망할 거야", "틀림없이 잘못될 거야", "앞으로도 안 될 거야"],
    "감정적 추리": ["기분이 이래 → 사실일 거야", "불안해 → 뭔가 잘못됐어"],
    "당위 진술": ["해야만 해", "꼭 이래야 해", "나는 그래야만 해"],
    "자기비난": ["나는 실패자야", "난 쓰레기야", "나는 형편없어"],
    "개인화": ["다 내 탓이야", "내가 잘못해서"]
}

trap_feedback = {
    "흑백 사고": "‘항상’, ‘절대’ 같은 단어는 상황을 극단적으로 만들 수 있어요. 정말 그런가요?",
    "과잉 일반화": "‘늘’, ‘전부’ 같은 표현은 한두 번의 경험을 전체로 확대시킬 수 있어요.",
    "정신적 여과": "혹시 부정적인 것만 보이고 있는 건 아닐까요? 긍정적인 부분은 어땠나요?",
    "긍정 무시": "좋은 일도 있었을 거예요. 칭찬받은 일은 정말 ‘우연’이었을까요?",
    "마음 읽기": "상대 마음을 미리 단정짓고 있진 않나요? 확인하지 않았는데 말이에요.",
    "예언하기": "미래는 정해지지 않았어요. 근거 없는 불안이 커지고 있는 건 아닐까요?",
    "감정적 추리": "감정은 진실을 말해주는 게 아닐 수도 있어요. 감정 ≠ 사실이에요.",
    "당위 진술": "‘반드시 ~해야 해’는 스스로를 압박하게 만들어요. 조금 유연해도 괜찮지 않을까요?",
    "자기비난": "당신은 ‘실패’ 그 자체가 아니에요. 실수는 누구에게나 있을 수 있어요.",
    "개인화": "모든 책임을 자신에게 돌리는 건 너무 가혹하지 않을까요?"
}

def detect_thinking_traps(text):
    detected_traps = []

    for trap, keywords in thinking_traps.items():
        for kw in keywords:
            if re.search(re.escape(kw), text):
                detected_traps.append(trap)
                break

    feedback = [trap_feedback[trap] for trap in detected_traps]

    return {
        "고정관념": detected_traps,
        "피드백": feedback
    }
